# .github/workflows/bot-scheduler.yml
name: Discord Bot Scheduler

on:
  schedule:
    # æ—¥æœ¬æ™‚é–“ AM 2:00 ã«åœæ­¢ (UTC 17:00 å‰æ—¥)
    - cron: '0 17 * * *'
    # æ—¥æœ¬æ™‚é–“ AM 10:00 ã«èµ·å‹• (UTC 1:00)  
    - cron: '0 1 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½
    inputs:
      action:
        description: 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³é¸æŠž'
        required: true
        default: 'status'
        type: choice
        options:
        - 'start'
        - 'stop'
        - 'status'
        - 'restart'

jobs:
  manage-bot:
    runs-on: ubuntu-latest
    steps:
      - name: Set JST Time
        id: time
        run: |
          echo "jst_time=$(TZ='Asia/Tokyo' date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "jst_hour=$(TZ='Asia/Tokyo' date +'%H')" >> $GITHUB_OUTPUT
          echo "utc_time=$(date -u +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT

      - name: Determine Action
        id: action
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "action=${{ github.event.inputs.action }}" >> $GITHUB_OUTPUT
          elif [ "${{ steps.time.outputs.jst_hour }}" = "02" ]; then
            echo "action=stop" >> $GITHUB_OUTPUT
          elif [ "${{ steps.time.outputs.jst_hour }}" = "10" ]; then
            echo "action=start" >> $GITHUB_OUTPUT
          else
            echo "action=status" >> $GITHUB_OUTPUT
          fi

      - name: Stop Discord Bot
        if: steps.action.outputs.action == 'stop'
        run: |
          echo "ðŸŒ™ Discord Bot ã‚’åœæ­¢ã—ã¾ã™ (JST: ${{ steps.time.outputs.jst_time }})"
          
          # Railway API ã§ Bot ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation serviceDelete($id: String!) { serviceDelete(id: $id) }",
              "variables": { "id": "${{ secrets.RAILWAY_SERVICE_ID }}" }
            }' \
            https://backboard.railway.app/graphql

          echo "âœ… Botåœæ­¢å®Œäº† - æ¬¡å›žèµ·å‹•: JST 10:00"

      - name: Start Discord Bot  
        if: steps.action.outputs.action == 'start'
        run: |
          echo "ðŸŒ… Discord Bot ã‚’èµ·å‹•ã—ã¾ã™ (JST: ${{ steps.time.outputs.jst_time }})"
          
          # Railway API ã§ Bot ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation serviceCreate($input: ServiceCreateInput!) { serviceCreate(input: $input) { id } }",
              "variables": { 
                "input": {
                  "projectId": "${{ secrets.RAILWAY_PROJECT_ID }}",
                  "source": { "repo": "${{ github.repository }}" }
                }
              }
            }' \
            https://backboard.railway.app/graphql

          echo "âœ… Botèµ·å‹•å®Œäº† - åœæ­¢äºˆå®š: JST 02:00"

      - name: Restart Discord Bot
        if: steps.action.outputs.action == 'restart'
        run: |
          echo "ðŸ”„ Discord Bot ã‚’å†èµ·å‹•ã—ã¾ã™ (JST: ${{ steps.time.outputs.jst_time }})"
          
          # Railway API ã§ Bot ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤
          curl -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation deploymentCreate($input: DeploymentCreateInput!) { deploymentCreate(input: $input) { id } }",
              "variables": { 
                "input": {
                  "serviceId": "${{ secrets.RAILWAY_SERVICE_ID }}"
                }
              }
            }' \
            https://backboard.railway.app/graphql

          echo "âœ… Botå†èµ·å‹•å®Œäº†"

      - name: Check Bot Status
        if: steps.action.outputs.action == 'status'
        run: |
          echo "ðŸ“Š Discord Bot ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª (JST: ${{ steps.time.outputs.jst_time }})"
          
          # Railway API ã§ Bot ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å–å¾—
          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "query service($id: String!) { service(id: $id) { id name updatedAt } }",
              "variables": { "id": "${{ secrets.RAILWAY_SERVICE_ID }}" }
            }' \
            https://backboard.railway.app/graphql)
          
          echo "Bot Status: $response"

      - name: Send Discord Notification
        if: steps.action.outputs.action == 'start' || steps.action.outputs.action == 'stop'
        run: |
          if [ "${{ steps.action.outputs.action }}" = "start" ]; then
            message="ðŸŒ… **Botèµ·å‹•é€šçŸ¥**\nâ° æ™‚åˆ»: ${{ steps.time.outputs.jst_time }} JST\nâœ… Discord ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³Bot ãŒç¨¼åƒé–‹å§‹ã—ã¾ã—ãŸ\nâ±ï¸ æ¬¡å›žåœæ­¢: æ˜Žæ—¥ AM 2:00"
            color="3066993"
          else
            message="ðŸŒ™ **Botåœæ­¢é€šçŸ¥**\nâ° æ™‚åˆ»: ${{ steps.time.outputs.jst_time }} JST\nðŸ˜´ Discord ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³Bot ã‚’åœæ­¢ã—ã¾ã—ãŸ\nâ±ï¸ æ¬¡å›žèµ·å‹•: AM 10:00"
            color="15158332"
          fi

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"description\": \"$message\",
                \"color\": $color,
                \"footer\": {
                  \"text\": \"GitHub Actions Bot Scheduler\"
                },
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"
              }]
            }" \
            "${{ secrets.DISCORD_WEBHOOK_URL }}"

      - name: Summary
        run: |
          echo "## ðŸ¤– Discord Bot Scheduler å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œæ™‚åˆ»**: ${{ steps.time.outputs.jst_time }} JST" >> $GITHUB_STEP_SUMMARY
          echo "- **å®Ÿè¡Œã‚¢ã‚¯ã‚·ãƒ§ãƒ³**: ${{ steps.action.outputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ç¨¼åƒã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«**: AM 10:00 - AM 2:00 (JST)" >> $GITHUB_STEP_SUMMARY
          echo "- **æœˆé–“ç¨¼åƒæ™‚é–“**: 480æ™‚é–“ (Railway 500æ™‚é–“åˆ¶é™å†…)" >> $GITHUB_STEP_SUMMARY